name: Release

on:
  push:
    tags:
      - 'v*'

env:
  CARGO_TERM_COLOR: always

jobs:
  build-binaries:
    name: Build Linux Binaries
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Free Disk Space
        run: |
          # Free up disk space on GitHub Actions runners
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          sudo docker image prune --all --force
          df -h
      
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
      
      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y musl-tools
      
      - name: Add musl target
        run: rustup target add x86_64-unknown-linux-musl
      
      - name: Build CLI (static binary)
        run: cargo build --release --target x86_64-unknown-linux-musl --bin jit
      
      - name: Build API server (static binary)
        run: cargo build --release --target x86_64-unknown-linux-musl --bin jit-server
      
      - name: Build dispatch coordinator (static binary)
        run: cargo build --release --target x86_64-unknown-linux-musl --bin jit-dispatch
      
      - name: Strip binaries
        run: |
          strip target/x86_64-unknown-linux-musl/release/jit
          strip target/x86_64-unknown-linux-musl/release/jit-server
          strip target/x86_64-unknown-linux-musl/release/jit-dispatch
      
      - name: Create tarball
        run: |
          mkdir -p dist
          tar -czf dist/jit-linux-x64.tar.gz \
            -C target/x86_64-unknown-linux-musl/release \
            jit jit-server jit-dispatch
      
      - name: Generate checksums
        run: |
          cd dist
          sha256sum jit-linux-x64.tar.gz > checksums.txt
      
      - name: Upload binaries
        uses: actions/upload-artifact@v4
        with:
          name: linux-binaries
          path: dist/

  package-mcp-server:
    name: Package MCP Server
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'
      
      - name: Install dependencies
        working-directory: mcp-server
        run: npm ci
      
      - name: Create package tarball
        working-directory: mcp-server
        run: npm pack
      
      - name: Upload package
        uses: actions/upload-artifact@v4
        with:
          name: mcp-server-package
          path: mcp-server/*.tgz

  build-web-ui:
    name: Build Web UI
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install dependencies
        working-directory: web
        run: npm ci
      
      - name: Build production bundle
        working-directory: web
        run: npm run build
      
      - name: Create archive
        run: |
          cd web/dist
          tar -czf ../../jit-web-ui.tar.gz .
      
      - name: Upload web bundle
        uses: actions/upload-artifact@v4
        with:
          name: web-ui-bundle
          path: jit-web-ui.tar.gz

  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [build-binaries, package-mcp-server, build-web-ui]
    
    permissions:
      contents: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts/
      
      - name: Display structure
        run: ls -R artifacts/
      
      - name: Create release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            artifacts/linux-binaries/jit-linux-x64.tar.gz
            artifacts/linux-binaries/checksums.txt
            artifacts/mcp-server-package/*.tgz
            artifacts/web-ui-bundle/jit-web-ui.tar.gz
          body: |
            ## Installation
            
            ### CLI & API Server (Linux x64)
            ```bash
            wget https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/jit-linux-x64.tar.gz
            tar -xzf jit-linux-x64.tar.gz
            sudo mv jit jit-server jit-dispatch /usr/local/bin/
            ```
            
            ### MCP Server (Node.js)
            ```bash
            npm install -g ${{ github.repository_owner }}/jit-mcp-server@${{ github.ref_name }}
            ```
            
            ### Web UI
            Extract `jit-web-ui.tar.gz` to your web server root.
            
            ## Checksums
            See `checksums.txt` for SHA256 verification.
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
